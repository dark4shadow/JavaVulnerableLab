<%@page import="java.io.DataInputStream"%>
<%@page import="java.io.FileInputStream"%>
 <%@page import="java.sql.Connection"%>
<%@page import="java.sql.Statement"%>
<%@page import="java.sql.SQLException"%>

<%@page import="java.sql.ResultSetMetaData"%>
<%@page import="java.sql.ResultSet"%>
<%@ page import="java.util.*,java.io.*"%>
<%@ page import="org.cysecurity.cspf.jvl.model.DBConnect"%>


<%@page import="java.io.File"%>
<%
  String path = request.getContextPath();
  try
  {
    String fileid=request.getParameter("fileid");
    if(fileid!=null && !fileid.equals(""))
    {
      // Wrap JDBC resources in try-with-resources so they always close even if an error occurs.
      try (Connection con=new DBConnect().connect(getServletContext().getRealPath("/WEB-INF/config.properties"));
           Statement stmt = con.createStatement();
           ResultSet rs = stmt.executeQuery("select * from FilesList where fileid="+fileid))
      {
        if(rs.next())
        {
          int BUFSIZE = 4096;
          String filePath=rs.getString("path");
          File file = new File(getServletContext().getRealPath(path));
          file = new File(file.getParent()+filePath);
          response.setContentType("text/html");
          response.setContentLength((int)file.length());
          String fileName = (new File(filePath)).getName();
          response.setHeader("Content-Disposition", "attachment; filename=\"" + fileName + "\"");
          byte[] byteBuffer = new byte[BUFSIZE];
          // File and servlet streams also use try-with-resources to avoid leaking descriptors.
          try (ServletOutputStream outStream = response.getOutputStream();
            DataInputStream in = new DataInputStream(new FileInputStream(file)))
          {
            int length;
            while ((length = in.read(byteBuffer)) != -1)
            {
              outStream.write(byteBuffer,0,length);
            }
          }
        }
        else
        {
          out.print("File Not Found");
        }
      }
    }
    else
    {
        out.print("File Parameter is missing");
    }
  }
  catch(Exception e)
  {
       out.print("Oops, Something Went wrong");
  }
    %>