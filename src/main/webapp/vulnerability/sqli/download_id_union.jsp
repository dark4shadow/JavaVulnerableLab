<%@page import="java.io.DataInputStream"%>
<%@page import="java.io.FileInputStream"%>
 <%@page import="java.sql.Connection"%>
<%@page import="java.sql.PreparedStatement"%>
<%@page import="java.sql.SQLException"%>

<%@page import="java.sql.ResultSetMetaData"%>
<%@page import="java.sql.ResultSet"%>
<%@ page import="java.util.*,java.io.*"%>
<%@ page import="org.cysecurity.cspf.jvl.model.DBConnect"%>


<%@page import="java.io.File"%>
<%!
  // Helper method to validate file path and prevent path traversal
  private boolean isValidFilePath(String filePath, String baseDir) {
    if (filePath == null || filePath.isEmpty()) {
      return false;
    }
    try {
      File file = new File(baseDir, filePath);
      String canonicalPath = file.getCanonicalPath();
      String canonicalBase = new File(baseDir).getCanonicalPath();
      // Ensure the file is within the base directory
      return canonicalPath.startsWith(canonicalBase);
    } catch (IOException e) {
      return false;
    }
  }
  
  // Helper method to validate file extension
  private boolean isAllowedFileType(String fileName) {
    if (fileName == null || fileName.isEmpty()) {
      return false;
    }
    String lowerName = fileName.toLowerCase();
    // Whitelist of allowed file extensions
    String[] allowedExtensions = {".pdf", ".txt", ".doc", ".docx", ".xls", ".xlsx", ".jpg", ".jpeg", ".png", ".gif", ".zip"};
    for (String ext : allowedExtensions) {
      if (lowerName.endsWith(ext)) {
        return true;
      }
    }
    return false;
  }
%>
<%
  String path = request.getContextPath();
  try
  {
    String fileid=request.getParameter("fileid");
    if(fileid!=null && !fileid.equals(""))
    {
      // Validate fileid is numeric to prevent SQL injection
      int fileIdInt;
      try {
        fileIdInt = Integer.parseInt(fileid);
      } catch (NumberFormatException e) {
        out.print("Invalid file ID");
        return;
      }
      
      // Wrap JDBC resources in try-with-resources so they always close even if an error occurs.
      // Use PreparedStatement to prevent SQL injection
      try (Connection con=new DBConnect().connect(getServletContext().getRealPath("/WEB-INF/config.properties"));
           PreparedStatement pstmt = con.prepareStatement("select * from FilesList where fileid=?"))
      {
        pstmt.setInt(1, fileIdInt);
        try (ResultSet rs = pstmt.executeQuery())
        {
          if(rs.next())
          {
            int BUFSIZE = 4096;
            String filePath=rs.getString("path");
            
            // Validate file path to prevent path traversal
            String baseDir = new File(getServletContext().getRealPath(path)).getParent() + File.separator + "docs";
            if (!isValidFilePath(filePath, baseDir)) {
              out.print("Invalid file path");
              return;
            }
            
            File file = new File(baseDir, filePath);
            
            // Check if file exists and is a regular file
            if (!file.exists() || !file.isFile()) {
              out.print("File Not Found");
              return;
            }
            
            // Validate file type
            if (!isAllowedFileType(file.getName())) {
              out.print("File type not allowed");
              return;
            }
            
            response.setContentType("application/octet-stream");
            response.setContentLength((int)file.length());
            String fileName = file.getName();
            // Sanitize header value to avoid reflected XSS/response splitting from DB data.
            fileName = fileName.replaceAll("[^a-zA-Z0-9._-]", "_");
            response.setHeader("Content-Disposition", "attachment; filename=\"" + fileName + "\"");
            byte[] byteBuffer = new byte[BUFSIZE];
            // File and servlet streams also use try-with-resources to avoid leaking descriptors.
            try (ServletOutputStream outStream = response.getOutputStream();
              DataInputStream in = new DataInputStream(new FileInputStream(file)))
            {
              int length;
              while ((length = in.read(byteBuffer)) != -1)
              {
                outStream.write(byteBuffer,0,length);
              }
            }
          }
          else
          {
            out.print("File Not Found");
          }
        }
      }
    }
    else
    {
        out.print("File Parameter is missing");
    }
  }
  catch(Exception e)
  {
       out.print("Oops, Something Went wrong");
  }
    %>